# Радиометр на ESP-IDF (ESP32-S3 WROOM-1 N16R8)

Порт Arduino-скетча на ESP-IDF под ESP32-S3 WROOM-1 N16R8: три LTC2440 по SPI, веб-интерфейс для просмотра напряжений и управления шаговым двигателем (TMC2208) плюс реле для калибровки нуля.

## Что внутри
- Wi‑Fi STA с установкой hostname и (опционально) кастомного MAC (`WIFI_SSID`, `WIFI_PASS`, `HOSTNAME`, `CUSTOM_MAC` в `main/app_main.cpp`).
- SPI2 (HSPI) с LTC2440 на выводах MISO 4, MOSI 5, SCK 6, CS 16/15/7. Шаговый двигатель: EN 35, DIR 36, STEP 37. Реле калибровки: 17. Проверьте соответствие вашей плате перед прошивкой.
- HTTP‑UI на порту 80 (страница `/` + API `/data`, `/calibrate`, `/stepper/enable|disable|move|stop|zero`), формат совпадает с исходным фронтом.
- Фоновые задачи: опрос АЦП каждые 200 мс, генерация шагов в отдельной задаче, калибровка (100 выборок, первые 10 отбрасываются).

## Сборка и прошивка локально
Требуется установленный ESP-IDF (5.x).
1) Выберите цель (при первом запуске):  
   `idf.py set-target esp32s3`
2) Сборка:  
   `idf.py build`
3) Прошивка и монитор (укажите свой порт):  
   `idf.py -p /dev/cu.usbserial-XXXX flash monitor`

Если меняли параметры подключения/пины, правьте константы в `main/app_main.cpp` и пересоберите.

## Использование
- После загрузки устройство подключается к Wi‑Fi, поднимает сервер на порту 80 и показывает IP в логе.
- Откройте `http://<ip>` — увидите веб-страницу с тремя каналами и контролами шаговика.
- Калибровка `/calibrate` включает реле на 1 с и собирает 100 выборок (20 с). Во время калибровки измерения ставятся на паузу; статус шаговика сохраняется.

## Devcontainer и Docker
В `.devcontainer/Dockerfile` используется официальный образ `espressif/idf` с предустановленным ESP-IDF. Откройте папку в VS Code через Dev Containers — получите готовую среду, где достаточно выполнить команды `idf.py build/flash/monitor`. Это избавляет от ручной установки тулчейна.

## Замечания по выводам для ESP32-S3 WROOM-1 N16R8
- Текущие пины (MISO 4, MOSI 5, SCK 6, CS 16/15/7, реле 17, шаговик 35/36/37) свободны на ESP32-S3 и не конфликтуют с встроенной флэш/PSRAM. Тем не менее, перед разводкой проверьте даташит/пин-аут именно вашей платы и корректируйте константы в `main/app_main.cpp`.
- Избегайте использования бут-страп пинов (0, 3, 45, 46) и USB D± (19, 20), если задействуете нативный USB.
- Для модулей N16R8 PSRAM уже подключена; при необходимости включите поддержку PSRAM в `idf.py menuconfig` → *Component config* → *ESP32S3-specific* → *Support for external, SPI-connected RAM*.
